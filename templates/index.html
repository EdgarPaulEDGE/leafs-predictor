{% extends "base.html" %}

{% block content %}

<!-- ===== LIVE SCORES TICKER ===== -->
<div class="live-ticker-wrap" id="tickerWrap" {% if not live_scores %}style="display:none"{% endif %}>
    <div class="live-ticker" id="liveTicker">
        {% for s in live_scores %}
        <a class="ticker-game {{ s.statusClass }}" href="/game/{{ s.gameId }}">
            <div class="ticker-team">
                <img src="https://assets.nhle.com/logos/nhl/svg/{{ s.away }}_dark.svg" alt="{{ s.away }}" class="ticker-logo">
                <span class="ticker-abbr">{{ s.away }}</span>
                <span class="ticker-score">{{ s.awayScore }}</span>
            </div>
            <div class="ticker-divider">
                <span class="ticker-status {{ s.statusClass }}">{{ s.status }}</span>
            </div>
            <div class="ticker-team">
                <span class="ticker-score">{{ s.homeScore }}</span>
                <span class="ticker-abbr">{{ s.home }}</span>
                <img src="https://assets.nhle.com/logos/nhl/svg/{{ s.home }}_dark.svg" alt="{{ s.home }}" class="ticker-logo">
            </div>
        </a>
        {% endfor %}
    </div>
    <div class="ticker-refresh-indicator" id="tickerRefresh">
        <span class="ticker-live-dot"></span> LIVE
    </div>
</div>

<div class="hero">
    <h1>EDGE NHL</h1>
    <p>Tippe auf Leafs-Spiele und tritt gegen das ML-Modell an!</p>
</div>

<!-- ===== USER DASHBOARD ===== -->
{% if user_stats and user_stats.total > 0 %}
<div class="card dashboard-card">
    <div class="dashboard-header">
        <h2>Dein Dashboard</h2>
        <span class="dashboard-user">üèí {{ g.username }}</span>
    </div>
    <div class="dashboard-grid">
        <div class="dashboard-stat">
            <span class="dashboard-stat-val {{ 'dashboard-accent' if user_stats.accuracy >= 60 }}">{{ user_stats.accuracy }}%</span>
            <span class="dashboard-stat-label">Genauigkeit</span>
        </div>
        <div class="dashboard-stat">
            <span class="dashboard-stat-val">{{ user_stats.points }}</span>
            <span class="dashboard-stat-label">Punkte</span>
        </div>
        <div class="dashboard-stat">
            <span class="dashboard-stat-val">{{ user_stats.correct }}/{{ user_stats.total }}</span>
            <span class="dashboard-stat-label">Richtig</span>
        </div>
        <div class="dashboard-stat">
            <span class="dashboard-stat-val">{{ user_stats.exact }}</span>
            <span class="dashboard-stat-label">Exakt</span>
        </div>
        {% if user_stats.streak > 0 %}
        <div class="dashboard-stat">
            <span class="dashboard-stat-val dashboard-streak">üî• {{ user_stats.streak }}</span>
            <span class="dashboard-stat-label">Streak</span>
        </div>
        {% endif %}
        <div class="dashboard-stat">
            <span class="dashboard-stat-val {{ 'dashboard-winning' if user_stats.beating_model else 'dashboard-losing' }}">
                {{ user_stats.points }} : {{ user_stats.model_points }}
            </span>
            <span class="dashboard-stat-label">Du vs. ML</span>
        </div>
    </div>
    {% if user_stats.pending > 0 %}
    <div class="dashboard-pending">
        <span>{{ user_stats.pending }} offene{{ 'r' if user_stats.pending == 1 else '' }} Tipp{{ 's' if user_stats.pending != 1 else '' }}</span>
    </div>
    {% endif %}

    {% if user_stats.badges %}
    <div class="badges-grid" style="margin-top:0.75rem; padding-top:0.75rem; border-top:1px solid var(--glass-border);">
        {% for b in user_stats.badges %}
        <div class="achievement-badge unlocked" title="{{ b.desc }}">
            <span class="badge-icon">{{ b.icon }}</span>
            {{ b.name }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}

<!-- TIPP REMINDER -->
{% if has_reminder and untipped_count > 0 %}
<div class="reminder-banner">
    <span class="reminder-text">‚ö†Ô∏è Du hast {{ untipped_count }} Spiel{{ 'e' if untipped_count != 1 }} ohne Tipp! <span>Scroll runter und tippe jetzt.</span></span>
</div>
{% endif %}

<!-- TRADE DEADLINE COUNTDOWN -->
<div class="card countdown-card" id="countdownCard">
    <div class="countdown-title">üîî Trade Deadline 2026</div>
    <div class="countdown-timer" id="countdownTimer"></div>
    <div class="countdown-date">7. M√§rz 2026, 15:00 Uhr ET</div>
</div>
<script>
(function() {
    var deadline = new Date('2026-03-07T20:00:00Z');
    var card = document.getElementById('countdownCard');
    var timer = document.getElementById('countdownTimer');
    function update() {
        var now = new Date();
        var diff = deadline - now;
        if (diff <= 0) { card.style.display = 'none'; return; }
        var d = Math.floor(diff / 86400000);
        var h = Math.floor((diff % 86400000) / 3600000);
        var m = Math.floor((diff % 3600000) / 60000);
        var s = Math.floor((diff % 60000) / 1000);
        timer.innerHTML =
            '<div class="countdown-unit"><span class="countdown-val">' + d + '</span><span class="countdown-label">Tage</span></div>' +
            '<div class="countdown-unit"><span class="countdown-val">' + h + '</span><span class="countdown-label">Std</span></div>' +
            '<div class="countdown-unit"><span class="countdown-val">' + m + '</span><span class="countdown-label">Min</span></div>' +
            '<div class="countdown-unit"><span class="countdown-val">' + s + '</span><span class="countdown-label">Sek</span></div>';
    }
    update();
    setInterval(update, 1000);
})();
</script>

{% if games %}
<div class="card">
    <div class="section-header">
        <h2>Kommende Spiele</h2>
        <span class="count">{{ games|length }}</span>
    </div>

    {% for game in games %}
        <div class="game-card">
            <div class="game-matchup">
                {% if game.is_home %}
                    <img src="https://assets.nhle.com/logos/nhl/svg/TOR_dark.svg"
                         alt="TOR" class="team-logo">
                    <span class="matchup-vs">vs</span>
                    <img src="https://assets.nhle.com/logos/nhl/svg/{{ game.opponent }}_dark.svg"
                         alt="{{ game.opponent }}" class="team-logo">
                {% else %}
                    <img src="https://assets.nhle.com/logos/nhl/svg/{{ game.opponent }}_dark.svg"
                         alt="{{ game.opponent }}" class="team-logo">
                    <span class="matchup-vs">vs</span>
                    <img src="https://assets.nhle.com/logos/nhl/svg/TOR_dark.svg"
                         alt="TOR" class="team-logo">
                {% endif %}
                <div class="game-details">
                    <div class="date">{{ game.date }}</div>
                    <div class="matchup-text">
                        {% if game.is_home %}
                            TOR vs. {{ game.opponent }}
                        {% else %}
                            {{ game.opponent }} vs. TOR
                        {% endif %}
                    </div>
                    <div class="venue">
                        <span class="venue-dot {{ 'home' if game.is_home else 'away' }}"></span>
                        {{ "Heimspiel" if game.is_home else "Auswartsspiel" }}
                    </div>
                </div>
            </div>
            {% if game.already_predicted %}
                <span class="btn btn-disabled">Bereits getippt</span>
            {% else %}
                <a href="{{ url_for('predict', game_id=game.game_id) }}" class="btn btn-primary">Tipp abgeben</a>
            {% endif %}
        </div>

        {# Fun Stat Card f√ºr dieses Spiel #}
        {% if game.fun_stat %}
        <div class="fun-stat-card">
            <div class="fun-stat-header">
                <span class="fun-stat-icon">{{ game.fun_stat.icon|safe }}</span>
                <div class="fun-stat-title">
                    <div class="fun-stat-label">{{ game.fun_stat.label }}</div>
                    <div class="fun-stat-desc">{{ game.fun_stat.desc }}</div>
                </div>
            </div>
            <div class="fun-stat-matchup">
                <div class="fun-stat-player tor">
                    <img src="{{ game.fun_stat.tor.headshot }}" alt="{{ game.fun_stat.tor.name }}" class="player-headshot" loading="lazy">
                    <div class="player-info">
                        <div class="player-name">{{ game.fun_stat.tor.name }}</div>
                        <div class="player-team-badge">
                            <img src="https://assets.nhle.com/logos/nhl/svg/TOR_dark.svg" alt="TOR" class="team-logo-xs">
                            TOR
                        </div>
                    </div>
                    <div class="player-stat {% if not game.fun_stat.reverse %}{% if game.fun_stat.tor.raw >= game.fun_stat.opp.raw %}leading{% endif %}{% else %}{% if game.fun_stat.tor.raw <= game.fun_stat.opp.raw %}leading{% endif %}{% endif %}">
                        {{ game.fun_stat.tor.value }}
                    </div>
                </div>
                <div class="fun-stat-vs">VS</div>
                <div class="fun-stat-player opp">
                    <div class="player-stat {% if not game.fun_stat.reverse %}{% if game.fun_stat.opp.raw >= game.fun_stat.tor.raw %}leading{% endif %}{% else %}{% if game.fun_stat.opp.raw <= game.fun_stat.tor.raw %}leading{% endif %}{% endif %}">
                        {{ game.fun_stat.opp.value }}
                    </div>
                    <div class="player-info right">
                        <div class="player-name">{{ game.fun_stat.opp.name }}</div>
                        <div class="player-team-badge">
                            <img src="https://assets.nhle.com/logos/nhl/svg/{{ game.fun_stat.opp.team }}_dark.svg" alt="{{ game.fun_stat.opp.team }}" class="team-logo-xs">
                            {{ game.fun_stat.opp.team }}
                        </div>
                    </div>
                    <img src="{{ game.fun_stat.opp.headshot }}" alt="{{ game.fun_stat.opp.name }}" class="player-headshot" loading="lazy">
                </div>
            </div>
        </div>
        {% endif %}

    {% endfor %}
</div>
{% else %}
<div class="card">
    <div class="empty-state">
        <p>Keine kommenden Spiele gefunden.</p>
        <p>Die NHL-Saison ist moeglicherweise vorbei oder die API ist nicht erreichbar.</p>
    </div>
</div>
{% endif %}
<script>
// Auto-Refresh Live Scores - initial load + every 30s
(function() {
    var REFRESH_INTERVAL = 30000;
    var ticker = document.getElementById('liveTicker');
    var wrap = document.getElementById('tickerWrap');
    var refreshDot = document.getElementById('tickerRefresh');
    if (!ticker) return;

    function updateTicker() {
        fetch('/api/live-scores')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!data.scores || data.scores.length === 0) {
                    wrap.style.display = 'none';
                    return;
                }
                wrap.style.display = '';

                // Show/hide LIVE indicator
                if (data.hasLive) {
                    refreshDot.classList.add('ticker-has-live');
                } else {
                    refreshDot.classList.remove('ticker-has-live');
                }

                // Rebuild ticker HTML
                var html = '';
                data.scores.forEach(function(s) {
                    html += '<a class="ticker-game ' + s.statusClass + '" href="/game/' + s.gameId + '">' +
                        '<div class="ticker-team">' +
                            '<img src="https://assets.nhle.com/logos/nhl/svg/' + s.away + '_dark.svg" alt="' + s.away + '" class="ticker-logo" loading="lazy">' +
                            '<span class="ticker-abbr">' + s.away + '</span>' +
                            '<span class="ticker-score">' + s.awayScore + '</span>' +
                        '</div>' +
                        '<div class="ticker-divider">' +
                            '<span class="ticker-status ' + s.statusClass + '">' + s.status + '</span>' +
                        '</div>' +
                        '<div class="ticker-team">' +
                            '<span class="ticker-score">' + s.homeScore + '</span>' +
                            '<span class="ticker-abbr">' + s.home + '</span>' +
                            '<img src="https://assets.nhle.com/logos/nhl/svg/' + s.home + '_dark.svg" alt="' + s.home + '" class="ticker-logo" loading="lazy">' +
                        '</div>' +
                    '</a>';
                });
                ticker.innerHTML = html;

                // Flash animation
                ticker.classList.add('ticker-updated');
                setTimeout(function() { ticker.classList.remove('ticker-updated'); }, 600);
            })
            .catch(function() {});
    }

    // Load immediately if ticker is empty (faster initial page load)
    if (!ticker.children.length) {
        updateTicker();
    }
    // Then poll every 30s
    setInterval(updateTicker, REFRESH_INTERVAL);
})();
</script>
{% endblock %}
