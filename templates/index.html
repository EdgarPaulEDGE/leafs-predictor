{% extends "base.html" %}

{% block content %}

<!-- ===== LIVE SCORES TICKER ===== -->
{% if live_scores %}
<div class="live-ticker-wrap">
    <div class="live-ticker">
        {% for s in live_scores %}
        <div class="ticker-game {{ s.statusClass }}">
            <div class="ticker-team">
                <img src="https://assets.nhle.com/logos/nhl/svg/{{ s.away }}_dark.svg" alt="{{ s.away }}" class="ticker-logo">
                <span class="ticker-abbr">{{ s.away }}</span>
                <span class="ticker-score">{{ s.awayScore }}</span>
            </div>
            <div class="ticker-divider">
                <span class="ticker-status {{ s.statusClass }}">{{ s.status }}</span>
            </div>
            <div class="ticker-team">
                <span class="ticker-score">{{ s.homeScore }}</span>
                <span class="ticker-abbr">{{ s.home }}</span>
                <img src="https://assets.nhle.com/logos/nhl/svg/{{ s.home }}_dark.svg" alt="{{ s.home }}" class="ticker-logo">
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="hero">
    <h1>EDGE NHL</h1>
    <p>Tippe auf Leafs-Spiele und tritt gegen das ML-Modell an!</p>
</div>

<!-- ===== USER DASHBOARD ===== -->
{% if user_stats and user_stats.total > 0 %}
<div class="card dashboard-card">
    <div class="dashboard-header">
        <h2>Dein Dashboard</h2>
        <span class="dashboard-user">üèí {{ g.username }}</span>
    </div>
    <div class="dashboard-grid">
        <div class="dashboard-stat">
            <span class="dashboard-stat-val {{ 'dashboard-accent' if user_stats.accuracy >= 60 }}">{{ user_stats.accuracy }}%</span>
            <span class="dashboard-stat-label">Genauigkeit</span>
        </div>
        <div class="dashboard-stat">
            <span class="dashboard-stat-val">{{ user_stats.points }}</span>
            <span class="dashboard-stat-label">Punkte</span>
        </div>
        <div class="dashboard-stat">
            <span class="dashboard-stat-val">{{ user_stats.correct }}/{{ user_stats.total }}</span>
            <span class="dashboard-stat-label">Richtig</span>
        </div>
        <div class="dashboard-stat">
            <span class="dashboard-stat-val">{{ user_stats.exact }}</span>
            <span class="dashboard-stat-label">Exakt</span>
        </div>
        {% if user_stats.streak > 0 %}
        <div class="dashboard-stat">
            <span class="dashboard-stat-val dashboard-streak">üî• {{ user_stats.streak }}</span>
            <span class="dashboard-stat-label">Streak</span>
        </div>
        {% endif %}
        <div class="dashboard-stat">
            <span class="dashboard-stat-val {{ 'dashboard-winning' if user_stats.beating_model else 'dashboard-losing' }}">
                {{ user_stats.points }} : {{ user_stats.model_points }}
            </span>
            <span class="dashboard-stat-label">Du vs. ML</span>
        </div>
    </div>
    {% if user_stats.pending > 0 %}
    <div class="dashboard-pending">
        <span>{{ user_stats.pending }} offene{{ 'r' if user_stats.pending == 1 else '' }} Tipp{{ 's' if user_stats.pending != 1 else '' }}</span>
    </div>
    {% endif %}
</div>
{% endif %}

{% if games %}
<div class="card">
    <div class="section-header">
        <h2>Kommende Spiele</h2>
        <span class="count">{{ games|length }}</span>
    </div>

    {% for game in games %}
        <div class="game-card">
            <div class="game-matchup">
                {% if game.is_home %}
                    <img src="https://assets.nhle.com/logos/nhl/svg/TOR_dark.svg"
                         alt="TOR" class="team-logo">
                    <span class="matchup-vs">vs</span>
                    <img src="https://assets.nhle.com/logos/nhl/svg/{{ game.opponent }}_dark.svg"
                         alt="{{ game.opponent }}" class="team-logo">
                {% else %}
                    <img src="https://assets.nhle.com/logos/nhl/svg/{{ game.opponent }}_dark.svg"
                         alt="{{ game.opponent }}" class="team-logo">
                    <span class="matchup-vs">vs</span>
                    <img src="https://assets.nhle.com/logos/nhl/svg/TOR_dark.svg"
                         alt="TOR" class="team-logo">
                {% endif %}
                <div class="game-details">
                    <div class="date">{{ game.date }}</div>
                    <div class="matchup-text">
                        {% if game.is_home %}
                            TOR vs. {{ game.opponent }}
                        {% else %}
                            {{ game.opponent }} vs. TOR
                        {% endif %}
                    </div>
                    <div class="venue">
                        <span class="venue-dot {{ 'home' if game.is_home else 'away' }}"></span>
                        {{ "Heimspiel" if game.is_home else "Auswartsspiel" }}
                    </div>
                </div>
            </div>
            {% if game.already_predicted %}
                <span class="btn btn-disabled">Bereits getippt</span>
            {% else %}
                <a href="{{ url_for('predict', game_id=game.game_id) }}" class="btn btn-primary">Tipp abgeben</a>
            {% endif %}
        </div>

        {# Fun Stat Card f√ºr dieses Spiel #}
        {% if game.fun_stat %}
        <div class="fun-stat-card">
            <div class="fun-stat-header">
                <span class="fun-stat-icon">{{ game.fun_stat.icon|safe }}</span>
                <div class="fun-stat-title">
                    <div class="fun-stat-label">{{ game.fun_stat.label }}</div>
                    <div class="fun-stat-desc">{{ game.fun_stat.desc }}</div>
                </div>
            </div>
            <div class="fun-stat-matchup">
                <div class="fun-stat-player tor">
                    <img src="{{ game.fun_stat.tor.headshot }}" alt="{{ game.fun_stat.tor.name }}" class="player-headshot">
                    <div class="player-info">
                        <div class="player-name">{{ game.fun_stat.tor.name }}</div>
                        <div class="player-team-badge">
                            <img src="https://assets.nhle.com/logos/nhl/svg/TOR_dark.svg" alt="TOR" class="team-logo-xs">
                            TOR
                        </div>
                    </div>
                    <div class="player-stat {% if not game.fun_stat.reverse %}{% if game.fun_stat.tor.raw >= game.fun_stat.opp.raw %}leading{% endif %}{% else %}{% if game.fun_stat.tor.raw <= game.fun_stat.opp.raw %}leading{% endif %}{% endif %}">
                        {{ game.fun_stat.tor.value }}
                    </div>
                </div>
                <div class="fun-stat-vs">VS</div>
                <div class="fun-stat-player opp">
                    <div class="player-stat {% if not game.fun_stat.reverse %}{% if game.fun_stat.opp.raw >= game.fun_stat.tor.raw %}leading{% endif %}{% else %}{% if game.fun_stat.opp.raw <= game.fun_stat.tor.raw %}leading{% endif %}{% endif %}">
                        {{ game.fun_stat.opp.value }}
                    </div>
                    <div class="player-info right">
                        <div class="player-name">{{ game.fun_stat.opp.name }}</div>
                        <div class="player-team-badge">
                            <img src="https://assets.nhle.com/logos/nhl/svg/{{ game.fun_stat.opp.team }}_dark.svg" alt="{{ game.fun_stat.opp.team }}" class="team-logo-xs">
                            {{ game.fun_stat.opp.team }}
                        </div>
                    </div>
                    <img src="{{ game.fun_stat.opp.headshot }}" alt="{{ game.fun_stat.opp.name }}" class="player-headshot">
                </div>
            </div>
        </div>
        {% endif %}

    {% endfor %}
</div>
{% else %}
<div class="card">
    <div class="empty-state">
        <p>Keine kommenden Spiele gefunden.</p>
        <p>Die NHL-Saison ist moeglicherweise vorbei oder die API ist nicht erreichbar.</p>
    </div>
</div>
{% endif %}
{% endblock %}
