{% extends "base.html" %}

{% block content %}
<div class="hero">
    <h1>Results</h1>
    <p>Your predictions and how they performed</p>
</div>

{% if resolved %}
<div class="export-bar">
    <a href="/api/export-stats" class="btn btn-secondary" onclick="if(typeof EdgeSounds!=='undefined')EdgeSounds.play('click');">
        ðŸ“¥ Export as CSV
    </a>
</div>
{% endif %}

<!-- PREDICTION CHARTS -->
{% if chart_data and chart_data.labels|length > 1 %}
<div class="card chart-card">
    <div class="section-header">
        <h2>ðŸ“ˆ Progress</h2>
    </div>
    <div class="chart-tabs">
        <button class="chart-tab active" onclick="switchChart(this, 'points')">Points</button>
        <button class="chart-tab" onclick="switchChart(this, 'accuracy')">Accuracy</button>
    </div>
    <div class="chart-container" id="chartPoints">
        <canvas id="pointsChart"></canvas>
    </div>
    <div class="chart-container" id="chartAccuracy" style="display:none;">
        <canvas id="accuracyChart"></canvas>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
var chartLabels = {{ chart_data.labels|tojson }};
var userPts = {{ chart_data.user_pts|tojson }};
var modelPts = {{ chart_data.model_pts|tojson }};
var accuracy = {{ chart_data.accuracy|tojson }};

var chartDefaults = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { labels: { color: '#e8f0ff', font: { family: 'Inter', size: 12 } } } },
    scales: {
        x: { ticks: { color: 'rgba(232,240,255,0.4)', maxTicksLimit: 10, font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
        y: { ticks: { color: 'rgba(232,240,255,0.4)', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.04)' } }
    }
};

new Chart(document.getElementById('pointsChart'), {
    type: 'line',
    data: {
        labels: chartLabels,
        datasets: [
            { label: 'You', data: userPts, borderColor: '#00e5ff', backgroundColor: 'rgba(0,229,255,0.1)', fill: true, tension: 0.3, pointRadius: 3, borderWidth: 2 },
            { label: 'ML-Modell', data: modelPts, borderColor: '#9b30ff', backgroundColor: 'rgba(155,48,255,0.1)', fill: true, tension: 0.3, pointRadius: 3, borderWidth: 2 }
        ]
    },
    options: chartDefaults
});

new Chart(document.getElementById('accuracyChart'), {
    type: 'line',
    data: {
        labels: chartLabels,
        datasets: [
            { label: 'Accuracy %', data: accuracy, borderColor: '#00e676', backgroundColor: 'rgba(0,230,118,0.1)', fill: true, tension: 0.3, pointRadius: 3, borderWidth: 2 }
        ]
    },
    options: Object.assign({}, chartDefaults, { scales: Object.assign({}, chartDefaults.scales, { y: Object.assign({}, chartDefaults.scales.y, { min: 0, max: 100 }) }) })
});

function switchChart(btn, type) {
    document.querySelectorAll('.chart-tab').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
    document.getElementById('chartPoints').style.display = type === 'points' ? 'block' : 'none';
    document.getElementById('chartAccuracy').style.display = type === 'accuracy' ? 'block' : 'none';
}
</script>
{% endif %}

{% if pending %}
<div class="card">
    <div class="section-header">
        <h2>Pending Predictions</h2>
        <span class="count">{{ pending|length }}</span>
    </div>

    {% for pred in pending %}
    <div class="prediction-card">
        <div class="pred-info">
            <img src="https://assets.nhle.com/logos/nhl/svg/{{ pred.opponent }}_dark.svg"
                 alt="{{ pred.opponent }}" class="team-logo">
            <div class="pred-text">
                <div class="pred-date">{{ pred.game_date }}</div>
                <div class="pred-matchup">
                    {% if pred.is_home %}
                        TOR vs {{ pred.opponent }}
                    {% else %}
                        {{ pred.opponent }} vs TOR
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="pred-details">
            <div class="pred-tip">
                <div class="tip-label">Your Prediction</div>
                <div class="tip-value">
                    <span class="badge badge-{{ 'win' if pred.user_prediction == 'W' else 'loss' }}">
                        {{ pred.user_prediction }}
                    </span>
                    {{ pred.user_score_leafs }}:{{ pred.user_score_opponent }}
                </div>
            </div>
            <div class="pred-tip">
                <div class="tip-label">ML-Modell</div>
                <div class="tip-value">
                    <span class="badge badge-{{ 'win' if pred.model_prediction == 'W' else 'loss' }}">
                        {{ pred.model_prediction }}
                    </span>
                    {{ pred.model_win_probability }}%
                </div>
            </div>
            <span class="badge badge-pending">Pending</span>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% if resolved %}
<div class="card">
    <div class="section-header">
        <h2>Completed Predictions</h2>
        <span class="count">{{ resolved|length }}</span>
    </div>

    <table class="results-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Game</th>
                <th>Result</th>
                <th>Your Prediction</th>
                <th>ML Prediction</th>
                <th>You</th>
                <th>ML</th>
            </tr>
        </thead>
        <tbody>
            {% for pred in resolved %}
            <tr>
                <td>{{ pred.game_date }}</td>
                <td>
                    <img src="https://assets.nhle.com/logos/nhl/svg/{{ pred.opponent }}_dark.svg"
                         alt="{{ pred.opponent }}" class="team-logo-sm">
                    {% if pred.is_home %}
                        TOR vs {{ pred.opponent }}
                    {% else %}
                        {{ pred.opponent }} vs TOR
                    {% endif %}
                </td>
                <td>
                    <span class="badge badge-{{ 'win' if pred.actual_result == 'W' else 'loss' }}">
                        {{ pred.actual_result }}
                    </span>
                    {{ pred.actual_score_leafs }}:{{ pred.actual_score_opponent }}
                </td>
                <td>
                    <span class="badge badge-{{ 'win' if pred.user_prediction == 'W' else 'loss' }}">
                        {{ pred.user_prediction }}
                    </span>
                    {{ pred.user_score_leafs }}:{{ pred.user_score_opponent }}
                </td>
                <td>
                    <span class="badge badge-{{ 'win' if pred.model_prediction == 'W' else 'loss' }}">
                        {{ pred.model_prediction }}
                    </span>
                    {{ pred.model_win_probability }}%
                </td>
                <td><span class="badge badge-points">{{ pred.user_points }}P</span></td>
                <td><span class="badge badge-points">{{ pred.model_points }}P</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if not pending and not resolved %}
<div class="card">
    <div class="empty-state">
        <p>No predictions submitted yet.</p>
        <p><a href="{{ url_for('index') }}" class="btn btn-primary">Make a prediction!</a></p>
    </div>
</div>
{% endif %}

<!-- Confetti for correct predictions -->
{% if resolved %}
{% set correct_count = resolved|selectattr('user_points', 'gt', 0)|list|length %}
{% if correct_count > 0 %}
<script>
(function() {
    var colors = ['#00e5ff', '#9b30ff', '#00e676', '#ffab00', '#ff5252', '#80f0ff'];
    var container = document.createElement('div');
    container.className = 'confetti-container';
    document.body.appendChild(container);
    var count = Math.min({{ correct_count }} * 15, 80);
    for (var i = 0; i < count; i++) {
        var c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = Math.random() * 100 + '%';
        c.style.background = colors[Math.floor(Math.random() * colors.length)];
        c.style.animationDelay = (Math.random() * 2) + 's';
        c.style.animationDuration = (2 + Math.random() * 2) + 's';
        c.style.width = (6 + Math.random() * 8) + 'px';
        c.style.height = (6 + Math.random() * 8) + 'px';
        c.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        container.appendChild(c);
    }
    setTimeout(function() { container.remove(); }, 5000);
})();
</script>
{% endif %}
{% endif %}
{% endblock %}
